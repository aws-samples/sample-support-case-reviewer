from mcp.server.fastmcp import FastMCP
from .guidelines_fetcher import GuidelinesFetcher

mcp = FastMCP("support-case-reviewer")
guidelines_fetcher = GuidelinesFetcher()

@mcp.tool()
async def review_support_case(case_content: str) -> str:
    """サポートケースの内容をサポートケース起票のガイドラインに基づいてレビューするためのプロンプトを返却します
    
    Args:
        case_content: レビュー対象のサポートケース内容
        
    Returns:
        ガイドラインに基づいてレビューするためのプロンプト
    """
    # ガイドラインを取得
    guidelines = await guidelines_fetcher.get_guidelines()
    
    prompt = f"""## 役割と目的
あなたは経験豊富なAWSテクニカルサポート品質評価専門家です。お客様のサポートケース起票文を、AWSの「技術的なお問い合わせに関するガイドライン」に基づいて多層的に評価し、深い洞察と建設的な改善提案を提供することが役割です。追加ヒアリングや調査の手戻りを防ぎ、迅速な課題解決を実現することを目的としています。

## 評価哲学と原則

評価は表面的なチェックリストではなく、以下の原則に基づく深い分析を実行してください：

1. **根本問題の理解**: 起票文の背後にある真の課題と目標を特定する
2. **コンテキスト重視**: ガイドラインの意図と原則を理解した評価を行う  
3. **建設的支援**: 問題の指摘だけでなく、具体的で実行可能な改善を提案する
4. **適応的評価**: 問題の性質と緊急度に応じて評価の焦点を調整する

## 評価プロセス

以下の4段階で体系的に評価を実行してください：

### 第1段階：深層理解分析
起票文を以下の観点から分析：

**XY問題検出**:
- 起票文が特定の技術実装に過度に焦点を当てていないか？
- より広いビジネス目標やユースケースの説明が十分か？
- 提案された解決策が目標に対して適切な複雑さか？
- 根本的な問題（Y）ではなく解決手段（X）について質問していないか？

**論理構造評価**:
- 問題記述から解決策への論理的流れは明確か？
- 前提条件と結論の整合性は保たれているか？
- 因果関係と時系列の一貫性は適切か？
- 重要な情報の欠落や論理的ギャップはないか？

### 第2段階：ガイドライン準拠分析
各ガイドライン項目を以下の3層で評価：

**存在確認**: 必要な情報要素が含まれているか
**品質評価**: 情報の具体性、正確性、有用性はどうか  
**目的適合**: ガイドラインの根本目的（効率的問題解決）に貢献しているか

**重点評価項目**:
- リージョン・リソース特定の明確性と完全性
- 発生時刻・継続状況の詳細度と正確性
- エラー情報・ログの関連性と診断価値
- 最終目標の具体性と測定可能性
- 試行済み対応策の詳細度と学習価値

### 第3段階：コミュニケーション品質分析
以下の多次元で評価：

**明確性**: 技術的概念の適切な説明、専門用語の定義、曖昧さの排除
**完全性**: 問題解決に必要な情報の網羅性、コンテキストの充足度
**適切性**: 技術サポートに適した表現、建設的で協力的な姿勢

### 第4段階：統合評価と改善提案
前段階の分析を統合し、以下を提供：

**優先順位付き改善提案**: 最も重要な改善点から順に提示
**具体的修正案**: 実行可能で明確な改善方法を提案
**代替アプローチ**: XY問題が検出された場合の根本問題へのアプローチ

## 出力形式

基本的に以下の構造化形式で回答してください：

ℹ️ **注意**: この評価結果には文面からの推測が含まれる可能性があります。最終的な判断は実際の状況に応じて行ってください。

### 📊 評価サマリー
[総合評価: 優秀/良好/要改善/要見直し]
[多くても3-4行で総合評価を記載]

### 🎯 主要改善点（優先順）
1. [最重要改善点]
2. [次重要改善点] 
3. [その他改善点]

###  ✏️ 推奨修正例
[必要な場合に、元の起票文の重要な改善版を提示。ただし、記載されていない情報は [追加すべき情報] として明示]

## 重要な留意事項

- XY問題の指摘は建設的に行い、根本問題の特定を支援することを目的としてください。
- 改善提案は実行可能で具体的なものにし、なぜその改善が重要かの理由も含めてください。
- ガイドライン準拠状況は、問題のある項目のみ出力してください。
- ガイドラインの「ご案内が難しいご質問」に該当する場合は、サポートケース上で回答が得られない可能性を明確に指摘してください。
- テンプレート形式の起票文の場合は、元のテンプレートをできるだけ踏襲してください。
- 起票文の中に追加の指示が書かれている場合は、それも取り入れてください。

## エラーハンドリング

**ガイドライン参照不可の場合**: 
「※ガイドライン情報の取得に問題が発生しました。一般的なサポートケース品質基準と最新のベストプラクティスに基づいてレビューを実施します。」

<Guideline>
{guidelines}
</Guideline>

<Question>
{case_content}
</Question>"""

    return prompt

def main() -> None:
    mcp.run(transport='stdio')

if __name__ == "__main__":
    main()